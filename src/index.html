<html>
<head>
    <title>threejs - test</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
        }
        canvas {

        }
    </style>
</head>
<body>
    <canvas id="myCanvas"></canvas>

    <script src="three.js"></script>
    <script src="colors.js"></script>
    <script src="trussData.js"></script>
    <script src="advTrussData.js"></script>
    <script src="trussUtils.js"></script>
    <script src="trussGenerator.js"></script>
    <script>
        var renderer = new THREE.WebGLRenderer({canvas: document.getElementById('myCanvas'), antialias: true});
        // renderer
        renderer.setClearColor(0x999999);
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(window.innerWidth, window.innerHeight);
        // camera, scene
        var camera = new THREE.PerspectiveCamera(35, window.innerWidth/window.innerHeight, 0.1, 3000);
        var origin = new THREE.Vector3(0,0,trussData.baseDimensions.depth / 2);
        var scene = new THREE.Scene();
        camera.position = origin;
        // lighting
        var ambientLight = THREE.AmbientLight(0xffffff, 1);
        var pointLight1 = new THREE.PointLight(0xffffff, 1);
        var pointLight2 = new THREE.PointLight(0xffffff, .5);
        pointLight1.position.set(1000,1000,1000);
        pointLight2.position.set(-500, 500, -500);
        scene.add(ambientLight);
        scene.add(pointLight1);
        scene.add(pointLight2);

        function renderBase(trussData) {
            // Base House
            var houseBaseGeometry = new THREE.BoxGeometry(trussData.baseDimensions.width, trussData.baseDimensions.height, trussData.baseDimensions.depth);
            var houseBaseMaterial = new THREE.MeshLambertMaterial({color: 0x999999, transparent: true, opacity: .5});
            var houseBaseMesh = new THREE.Mesh(houseBaseGeometry, houseBaseMaterial);
            houseBaseMesh.position.set(0, trussData.baseDimensions.height / 2,
                trussData.baseDimensions.depth / 2);
            scene.add(houseBaseMesh);
        }


        function renderTrusses(trussData, trussMeshes) {
            // debugger;
            trussMeshes = [];
            var loadBearingMaterial = new THREE.MeshLambertMaterial({color: 0xff8800});
            var standardMaterial = new THREE.MeshLambertMaterial({color: 0xffffff});
            var defaultTruss = trussData.defaultTruss;

            var totalTrussCount = trussData.trusses.length;
            //debugger;
            for(var i=0; i<totalTrussCount; i++) {
                // get truss data, pulling from default if not present
                var truss = trussData.trusses[i];
                truss.dimensions = truss.dimensions || defaultTruss.dimensions;
                truss.loadBearing = truss.loadBearing || defaultTruss.loadBearing;
                truss.type = truss.type || defaultTruss.type;
                var trussGeometry = generateTrussGeometry(truss);
                var trussMaterial = truss.loadBearing ? loadBearingMaterial : standardMaterial;
                var trussMesh = new THREE.Mesh(trussGeometry, trussMaterial);
                trussMesh.position.set(0, trussData.baseDimensions.height, truss.position);
                scene.add(trussMesh);
                trussMeshes.push(trussMesh);
            }
        }

        function rotateMesh(mesh, x, y) {
            mesh.rotation.x += x;
            mesh.rotation.y += y;
        }
        var cameraDelta = 0;
        function rotateCamera(target, delta, height, distance) {
            cameraDelta += delta;
            camera.lookAt(target);
            camera.position.x = Math.sin(cameraDelta) * distance;
            camera.position.z = Math.cos(cameraDelta) * distance;
            camera.position.y = height;
        }
        function render() {
                //rotateMesh(houseBaseMesh, 0, 0.1);
                rotateCamera(origin, .01, trussData.baseDimensions.height + 50, 1000);
                renderer.render(scene, camera);
                requestAnimationFrame(render);
        };
        var trussMeshes = [];
        var anchors = generateAnchors(advTrussData.walls, colors.orange);
        var wallSegments = generateWalls(advTrussData.walls);
        var posts = generatePosts(advTrussData.walls);
        for(var i=0;i<anchors.length;i++) {
            scene.add(anchors[i]);
        }
        for(var i=0;i<wallSegments.length;i++) {
            scene.add(wallSegments[i]);
        }
        for(var i=0;i<posts.length;i++) {
            scene.add(posts[i]);
        }
        // renderBase(trussData);
        // renderTrusses(trussData, trussMeshes);
        render();
    </script>
</body>
</html>
